# 数据库

## ACID

### 原子性（Atomicity）

事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。

回滚可以用回滚日志（Undo Log）来实现，回滚日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。

### 一致性（Consistency）

逻辑一致，由用户保证。例如转账场景下，用户A账户扣除50 用户B账户添加50，不能出现其他情况。

### 隔离性（Isolation）

一个事务所做的修改在最终提交以前，对其它事务是不可见的。

### 持久性（Durability）

一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。

## 范式

1. 第一范式：属性不可分。
2. 第二范式：每个非主属性完全函数依赖于键码。
3. 第三范式：非主属性不传递函数依赖于键码。

## 封锁协议

1. 一级封锁协议 事务 T 要修改数据 A 时必须加 X 锁，直到 T 结束才释放锁。解决丢失修改问题。
2. 二级封锁协议 在一级的基础上，要求读取数据 A 时必须加 S 锁，读取完马上释放 S 锁。解决脏读问题。
3. 三级封锁协议 在二级的基础上，要求读取数据 A 时必须加 S 锁，直到事务结束了才能释放 S 锁。解决不可重复读问题。

## B+树相对B树的优势

1. B+树的非叶子节点不保存数据，所以磁盘页能容纳更多的节点元素，更矮胖。
2. B+树查询必须到叶子节点，而B树只需要匹配到元素位置，所以B+树更稳定。
3. 范围查找来说，B+树只需遍历叶子节点链表，而B树需要重复地中序遍历。

## log

### redo log

重做日志只与InnoDB有关，是记录每个页的更改的物理情况，即使在事务进行过程中，不断有重做日志条目被写入重做日志文件中，其是按扇区大小写入，单次写入是安全的，所以不需要双写。

刷盘策略 innodb_flush_log_at_trx_commit。InnoDB存储引擎有一个后台线程，每隔1秒，就会把redo log buffer中的内容写到文件系统缓存（page cache）,然后调用刷盘操作。

1. 设置为0，表示每次事务提交时不进行刷盘操作。默认master thread每隔1s进行一次重做日志的同步
2. 设置为1，表示每次事务提交时都将进行同步，刷盘操作（ 默认值 ）
3. 设置为2，表示每次事务提交时都只把 redo log buffer 内容写入 page cache，不进行同步。由os自己决定什么时候同步到磁盘文件。

### bin log

二进制日志记录对数据库执行更改的所有操作（主要用于复制）在使用事务时，所有未提交的二进制日志都被记录到一个缓存中，等待事务提交时将缓冲区日志写入日志文件中。格式分为 Statement（逻辑SQL）ROW（行更改情况）MIX（混合）

### undo log

回滚日志，逻辑日志，记录数据库修改前的数据

## 脏页双写流程

1. 产生redo log
2. 脏页写入double write buffer
3. double write buffer 写入 double write file
4. double write buffer 写入 数据文件

## 索引失效

1. 使用不等号 not in
2. 使用or连接不同的字段
3. like 以%开头
4. 联合索引不满足最左前缀
5. 对字段添加了函数、运算符
6. 字段和条件类型不一致

## explain

### type

all, index, range, ref, eq_ref, const, system 从左到右，性能从最差到最好。

## 索引优点

1. 加速数据检索速度
2. 唯一索引保证唯一
3. 加速表与表之间的连接

## SQL执行顺序

1. from
2. on
3. join
4. where
5. group by
6. having
7. select
8. distinct
9. order by
10. limit

## InnoDB 和 MyISAM 比较

1. 事务：InnoDB 是事务型的，可以使用 Commit 和 Rollback 语句。
2. 并发：MyISAM 只支持表级锁，而 InnoDB 还支持行级锁。
3. 外键：InnoDB 支持外键。
4. 备份：InnoDB 支持在线热备份。
5. 崩溃恢复：MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。
6. 其它特性：MyISAM 支持压缩表和空间数据索引。